# üìò D√©ploiement GitLab Runner avec Docker distant via SSH

## üß≠ PR√âAMBULE : Pourquoi structurer son projet avec des branches ?

L‚Äôorganisation du projet avec plusieurs branches Git permet une gestion propre et professionnelle du code :

- **main** : branche de production. Contient uniquement du code valid√©, test√©, pr√™t √† √™tre mis en production.
- **develop** : branche de d√©veloppement. On y int√®gre les nouvelles fonctionnalit√©s, elle pr√©c√®de `main`.
- **feature/** : branches temporaires cr√©√©es depuis `develop`, pour ajouter une fonctionnalit√©.
- **bugfix/** : branches correctives temporaires.
- **hotfix/** : branches urgentes cr√©√©es depuis `main`, pour des corrections en prod.

Avantages :
- √âviter les erreurs en production
- Permettre le travail en √©quipe
- Favoriser l‚Äôint√©gration continue (CI)
- Faciliter les revues de code

---

## üîé Comprendre l‚Äôarchitecture

| Machine                  | R√¥le                                            | Docker | GitLab Runner |
|--------------------------|--------------------------------------------------|--------|----------------|
| üíª `gitlab.techwave.lab` | H√©berge l‚Äôinterface GitLab, les projets et CI/CD | ‚ùå     | ‚ùå             |
| üèÉ `runner-host`         | Machine d√©di√©e au GitLab Runner                  | ‚ùå     | ‚úÖ             |
| üê≥ `docker-host`         | Machine distante qui ex√©cute les jobs Docker     | ‚úÖ     | ‚ùå             |

---

## üß± PR√âREQUIS

- Une VM Debian 12 pour Docker (`docker-host`)
- Une VM Debian 12 pour GitLab Runner (`runner-host`)
- Une instance GitLab auto-h√©berg√©e : https://gitlab.techwave.lab
- Un projet GitLab cible : https://gitlab.techwave.lab/salle-8/runner-test-najuma.git
- Acc√®s administrateur aux deux VMs

---

## üë§ √âTAPE 1 ‚Äî Cr√©er les utilisateurs n√©cessaires

### Sur `docker-host` (machine Docker) :

```bash
sudo useradd runner -m -s /bin/bash
sudo usermod -aG docker runner
```

### Sur `runner-host` (machine GitLab Runner) :

```bash
sudo useradd gitlab-runner -m -s /bin/bash
```

üõ†Ô∏è **Remarque importante : Donner les droits sudo √† gitlab-runner**

Sur `runner-host`, connectez-vous avec un utilisateur ayant les droits administrateur (ex : `loic`) et ex√©cutez :

```bash
sudo usermod -aG sudo gitlab-runner
```

Ensuite, reconnectez-vous avec `gitlab-runner` :

```bash
su - gitlab-runner
```
üõ†Ô∏è **Remarque importante :**  
Si la commande `su - gitlab-runner` retourne une erreur d'authentification (`Authentication failure`), cela signifie que l'utilisateur `gitlab-runner` n'a pas encore de mot de passe d√©fini.

### ‚û§ Solution :

```bash
sudo passwd gitlab-runner
```

üëâ Entrez un mot de passe s√©curis√©, puis r√©essayez :

```bash
su - gitlab-runner
```

---

## üîê √âTAPE 2 ‚Äî G√©n√©rer et ajouter une cl√© SSH

### Sur `runner-host` :

```bash
su - gitlab-runner
ssh-keygen -t ed25519
cat ~/.ssh/id_ed25519.pub
---

---

## üì• √âTAPE 2.1 ‚Äî Copier la cl√© publique sur le `docker-host`

### Sur `runner-host` :

Afficher la cl√© publique g√©n√©r√©e :

```bash
cat /home/gitlab-runner/.ssh/id_ed25519.pub
```

üëâ **Copier tout le contenu affich√©** (c‚Äôest une ligne qui commence par `ssh-ed25519 ...`).

---

### Sur `docker-host` :

Cr√©er le dossier `.ssh` et coller la cl√© :

```bash
sudo mkdir -p /home/runner/.ssh
sudo nano /home/runner/.ssh/authorized_keys
```

üìå Colle la cl√© copi√©e dans ce fichier, puis enregistre.

Configurer les permissions correctement :

```bash
sudo chmod 700 /home/runner/.ssh
sudo chmod 600 /home/runner/.ssh/authorized_keys
sudo chown -R runner:runner /home/runner/.ssh
```

---

### ‚úÖ V√©rification de la connexion SSH

Depuis `runner-host`, toujours sous l‚Äôutilisateur `gitlab-runner` :

```bash
ssh runner@IP_DU_DOCKER_HOST
```

üëâ **Tu dois √™tre connect√© directement sans que le syst√®me demande de mot de passe.**  
C‚Äôest le signe que **l‚Äôauthentification par cl√© fonctionne correctement** et que le GitLab Runner pourra s‚Äôy connecter automatiquement pour ex√©cuter des jobs Docker √† distance.**
```

> Copie la cl√© affich√©e pour la coller sur le serveur Docker.

### Sur `docker-host` :

```bash
sudo mkdir -p /home/runner/.ssh
sudo nano /home/runner/.ssh/authorized_keys
# ‚û§ Colle ici la cl√© copi√©e depuis le runner-host
sudo chmod 700 /home/runner/.ssh
sudo chmod 600 /home/runner/.ssh/authorized_keys
sudo chown -R runner:runner /home/runner/.ssh
```

### V√©rification :

```bash
ssh runner@IP_DU_DOCKER_HOST
```

---

---

## üê≥ √âTAPE 3 ‚Äî Installer Docker sur `docker-host`

### Connexion √† la machine `SRV-DEB12-DOCKER` :

```bash
ssh runner@IP_DU_DOCKER_HOST
```

### Installation de Docker :

```bash
sudo apt update
sudo apt install -y docker.io
```

### Activer et d√©marrer le service Docker :

```bash
sudo systemctl enable docker
sudo systemctl start docker
```

### Ajouter l‚Äôutilisateur `runner` au groupe `docker` :

```bash
sudo usermod -aG docker runner
```

> üîÅ **D√©connecte-toi puis reconnecte-toi** (ou utilise `newgrp docker`) pour que les changements de groupe prennent effet.

### V√©rification :

```bash
docker ps
```

---

## üèÉ √âTAPE 4 ‚Äî Installer GitLab Runner sur `runner-host`

### Ajouter l'utilisateur `gitlab-runner` au groupe sudo (√† faire depuis un utilisateur avec privil√®ges, ex. `loic`) :

```bash
sudo usermod -aG sudo gitlab-runner
```

> üîÅ Ensuite, reconnecte-toi avec :  
> `su - gitlab-runner`

---

### Installation du d√©p√¥t GitLab Runner :

```bash
curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash
```

### Installation du paquet :

```bash
sudo apt install -y gitlab-runner
```

### V√©rification de l'installation :

```bash
gitlab-runner --version
```

---

---

---

## üõ†Ô∏è AVANT √âTAPE 5 ‚Äî Assurer la r√©solution DNS de GitLab

Si votre GitLab auto-h√©berg√© n'est pas enregistr√© dans un DNS public ou interne, vous devez forcer sa r√©solution dans le fichier `/etc/hosts` de la machine `runner-host`.

### Sur `runner-host` :

```bash
sudo nano /etc/hosts
```

Ajouter cette ligne tout en bas (‚ö†Ô∏è adaptez l'IP si besoin) :

```bash
10.100.0.203 gitlab.techwave.lab
```

üí° Cela permet √† la commande `gitlab-runner register` de contacter votre instance GitLab.

---

## üîó √âTAPE 5 ‚Äî Enregistrer le runner via SSH

### Depuis l‚Äôinterface GitLab :

Rends-toi dans le projet :

**Projet :** `Salle-8 / runner-test-Najuma`  
Navigue vers :

- **Fran√ßais** : `Param√®tres > CI/CD > Runners > Nouveau runner de projet`
- **English** : `Settings > CI/CD > Runners > New project runner`

Remplis les champs suivants :

- **Description / Description** : `runner-docker-najuma`
- **Tags / √âtiquettes** : `ssh, docker`
- **Options** :
  - ‚úÖ **Fran√ßais** : Cocher `Ex√©cuter les jobs sans √©tiquette`, `Prot√©g√©`, et `Limiter au projet actuel`
  - ‚úÖ **English** : Check `Run untagged jobs`, `Protected`, and `Lock to current project`
- **Token / Jeton** : Copier le jeton affich√©

---

### Depuis `runner-host` (machine GitLab Runner) :

Lancer l‚Äôenregistrement du runner :

```bash
sudo gitlab-runner register
```

R√©pondre aux questions comme suit :

- **URL GitLab** : `https://gitlab.techwave.lab/`
- **Token / Jeton** : (coller le jeton copi√©)
- **Description / Description** : `runner-docker-najuma`
- **Tags / √âtiquettes** : `ssh,docker`
- **Executor / Ex√©cuteur** : `ssh`
- **Adresse SSH** : `runner@10.108.0.102`
- **Chemin de la cl√© priv√©e SSH / Private key path** : `/home/gitlab-runner/.ssh/id_ed25519`

---

## ‚ùó Probl√®me possible ‚Äî Erreur de v√©rification TLS (x509 SAN)

Si vous obtenez cette erreur lors de l'enregistrement du runner :

```
tls: failed to verify certificate: x509: certificate relies on legacy Common Name field, use SANs instead
```

### üß† Explication :

Depuis Go 1.15+, utilis√© par GitLab Runner, les certificats SSL **doivent** inclure un champ `Subject Alternative Name (SAN)`.  
Un certificat qui n‚Äôa qu‚Äôun `Common Name` (CN) est consid√©r√© comme invalide.

Cela peut arriver si votre GitLab auto-h√©berg√© utilise un certificat SSL auto-sign√© ou mal g√©n√©r√©.

---

### ‚úÖ Solution rapide (si GitLab est de confiance) : ignorer la v√©rification TLS

Ajoutez l‚Äôoption `--tls-skip-verify` √† la commande `register` :

```bash
sudo gitlab-runner register --tls-skip-verify   --url https://gitlab.techwave.lab   --token VOTRE_TOKEN_ICI
```

‚ö†Ô∏è √Ä n'utiliser que si :
- le GitLab est en interne
- vous faites confiance √† votre certificat

---

### üîê Solution recommand√©e (production) : recr√©er un certificat valide

Il faut g√©n√©rer un certificat avec une section `[ alt_names ]` :

```ini
[ alt_names ]
DNS.1 = gitlab.techwave.lab
```

Et inclure cette section dans la configuration OpenSSL lors de la cr√©ation du certificat.

---

## ‚ö†Ô∏è Note : `gitlab-runner verify` peut √©chouer malgr√© une configuration correcte

M√™me si le fichier `/etc/gitlab-runner/config.toml` contient bien `tls_skip_verify = true`,  
la commande suivante peut toujours √©chouer :

```bash
sudo gitlab-runner verify
```

Erreur typique :

```
tls: failed to verify certificate: x509: certificate relies on legacy Common Name field, use SANs instead
```

### ‚úÖ Pourquoi ce n‚Äôest pas bloquant :

La commande `verify` utilise une v√©rification TLS stricte **qui ne respecte pas le champ `tls_skip_verify`**, mais **le runner fonctionnera quand m√™me dans les jobs CI/CD**, car cette v√©rification est contourn√©e au moment de l'ex√©cution r√©elle.

---

## ‚úÖ √âtape recommand√©e : tester avec un pipeline GitLab

Ajoute ce fichier `.gitlab-ci.yml` √† la racine de ton d√©p√¥t :

```yaml
stages:
  - test

test_job:
  stage: test
  tags:
    - ssh
    - docker
  script:
    - echo "üéâ Runner SSH + Docker op√©rationnel"
    - docker ps
```

Puis pousse sur ta branche GitLab :

```bash
git add .gitlab-ci.yml
git commit -m "test: runner SSH + Docker"
git push origin main
```

‚û°Ô∏è V√©rifie dans **GitLab > CI/CD > Pipelines** que le job se lance.

## üóÇÔ∏è √âTAPE 6 ‚Äî Pr√©parer les environnements `/opt/app/test` et `/opt/app/prod` sur `docker-host`

```bash
sudo mkdir -p /opt/app/test /opt/app/prod
sudo chmod -R 770 /opt/app
sudo chgrp -R docker /opt/app
```
---

## üìÅ √âTAPE 7 ‚Äî Initialiser un d√©p√¥t Git

```bash
mkdir mon-projet && cd mon-projet
git init
git add .
git remote add origin https://gitlab.com/VOTRE_USER/NOM_DEPOT.git
git branch -M main
git push -u origin main
```

üìå **Pourquoi ?**  
Permet de versionner le code, collaborer, activer les pipelines et g√©rer les livraisons dans GitLab.

---

## üå± √âTAPE 8 ‚Äî Cr√©er et prot√©ger la branche develop

```bash
git checkout -b develop
git push -u origin develop
```

üìå **Pourquoi ?**  
D√©velopper sans impacter la prod. Permet de pr√©parer le code avant sa validation finale.

---

## üîÑ √âTAPE 9 ‚Äî Cycle de d√©veloppement

```bash
git checkout develop
git checkout -b feature/ma-feature
# modifications
git add .
git commit -m "feat: ajout"
git push origin feature/ma-feature
```

üìå **Pourquoi ?**  
Isoler chaque √©volution dans une branche claire pour faciliter la review et garder un historique propre.

---

## üß™ √âTAPE 10 ‚Äî Fichier `.gitlab-ci.yml`

```yaml
stages:
  - test

test_job:
  stage: test
  script:
    - echo "üéâ Runner SSH + Docker op√©rationnel"
    - docker ps
```

üìå **Pourquoi ?**  
D√©clenche une action automatique √† chaque push : base d'un pipeline CI/CD.

---

## üîê √âTAPE 11 ‚Äî Ajouter des variables d‚Äôenvironnement

üìå **Pourquoi ?**  
Stocker des secrets, des configs ou chemins selon l‚Äôenvironnement sans exposer de donn√©es sensibles dans le code.

---

## üöÄ √âTAPE 12 ‚Äî D√©ploiement en production

```bash
git checkout develop
git pull origin develop
git checkout main
git pull origin main
git merge develop
git push origin main
```

üìå **Pourquoi ?**  
Livrer manuellement en production apr√®s validation. Le pipeline associ√© √† `main` d√©clenche le d√©ploiement final.

---

## üõ†Ô∏è Commandes utiles GitLab Runner

```bash
sudo cat /etc/gitlab-runner/config.toml
sudo gitlab-runner list
sudo gitlab-runner restart
sudo gitlab-runner upgrade
```

---

## üõ†Ô∏è Alternative ‚Äî Enregistrer un runner avec certificat TLS invalide

Si votre GitLab auto-h√©berg√© utilise un certificat sans SAN (erreur `x509: certificate relies on legacy Common Name field`), l‚Äôenregistrement `gitlab-runner register` √©chouera m√™me avec `GITLAB_RUNNER_TLS_SKIP_VERIFY`.

Voici une m√©thode manuelle pour contourner ce probl√®me :

---

### 1. Cr√©er un fichier de configuration temporaire

```bash
mkdir -p ~/runner-register-tmp
cd ~/runner-register-tmp
nano config.toml
```

### 2. Contenu √† coller dans `config.toml` :

```toml
[[runners]]
  name = "runner-docker-najuma"
  url = "https://gitlab.techwave.lab"
  token = "glrt-t3_Jx3AdWooQETz35Zwvrjs"
  tls_skip_verify = true
  executor = "ssh"
  [runners.ssh]
    user = "runner"
    host = "10.108.0.102"
    identity_file = "/home/gitlab-runner/.ssh/id_ed25519"
    disable_strict_host_key_checking = true
```

Enregistre le fichier (`Ctrl + O`, `Entr√©e`, puis `Ctrl + X` pour quitter).

---

### 3. Copier ce fichier dans la configuration GitLab Runner

```bash
sudo cp config.toml /etc/gitlab-runner/config.toml
sudo chown gitlab-runner:gitlab-runner /etc/gitlab-runner/config.toml
```

---

### 4. Red√©marrer et v√©rifier le runner

```bash
sudo gitlab-runner restart
sudo gitlab-runner verify
```

---

## üß™ Cr√©er le fichier `.gitlab-ci.yml` de test

Sur ta machine locale (ou sur une VM clon√©e du repo GitLab), cr√©e un fichier `.gitlab-ci.yml` pour tester le runner :

```bash
cd ~/chemin/vers/ton/projet
nano .gitlab-ci.yml
```

Colle ce contenu dans le fichier :

```yaml
stages:
  - test

test_job:
  stage: test
  tags:
    - ssh
    - docker
  script:
    - echo "üéâ Runner SSH + Docker op√©rationnel"
    - docker ps
```

Sauvegarde avec `Ctrl + O`, puis quitte `nano` avec `Ctrl + X`.

---

### üíæ Enregistre et pousse le fichier dans GitLab

```bash
git add .gitlab-ci.yml
git commit -m "test: runner SSH + Docker"
git push origin main
```

‚û°Ô∏è Puis v√©rifie dans l‚Äôinterface GitLab que le pipeline est bien lanc√© :  
**GitLab > CI/CD > Pipelines**